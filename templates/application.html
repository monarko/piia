<!DOCTYPE html>
<html lang="<%= current_lang %>">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <meta content="ie=edge" http-equiv="x-ua-compatible">
    <title>
        <%= t("meta_title") %>
    </title>
    <link href="https://fonts.googleapis.com/css?family=Rubik:300,400,500" rel="stylesheet" type="text/css">
    <%= stylesheetTag("application.css") %>
    <meta name="csrf-param" content="authenticity_token" />
    <meta name="csrf-token" content="<%= authenticity_token %>" />
    <link rel="icon" href="<%= assetPath("images/favicon.png") %>">
    <link rel="apple-touch-icon" href="<%= assetPath("images/apple-touch-icon.png") %>">
</head>

<body class="menu-position-side menu-side-left full-screen">
    <div class="all-wrapper with-side-panel solid-bg-all" style="height: 100vh;">
        <div class="layout-w">
            <!--------------------
            START - Main Menu
            -------------------->
            <div class="menu-w selected-menu-color-light menu-activated-on-hover menu-has-selected-link color-scheme-light color-style-transparent sub-menu-color-bright menu-position-side menu-side-left menu-layout-full sub-menu-style-over" style="padding-top: 10px; background: #F2F4F8">
                <div class="logo-w">
                    <a class="logo" href="<%= rootPath() %>">
                        <div class="logo-element"></div>
                        <div class="logo-label">
                            <%= t("header_title") %>
                        </div>
                    </a>
                </div>
                <div class="menu-actions">
                    <ul class="main-menu">
                        <li class="sub-header">
                            <div class="menu-actions">
                                    <div class="btn-group" style="width: 100%;">
                                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="width: 100%; text-align: left;font-size: 1rem;font-weight: bold;">
                                            <%= if (len(current_site) > 0) { %>
                                                <%= t("site_" + current_site) %>
                                            <% } else { %>
                                                <%= t("site_all") %>
                                            <% } %>
                                        </button>
                                        <div class="dropdown-menu" style="width: 100%;">
                                            <%= if (current_user.Permission.Screening && !(current_user.Admin || current_user.Permission.StudyCoordinator)) { %>
                                                <a class="dropdown-item active" style="padding: 5px 10px;" href="<%= switchSitePath() %>?site=<%= current_site %>"><%= t("site_" + current_site) %></a>
                                            <% } else { %>
                                                <a class="dropdown-item <%= if (len(current_site) == 0) { %>active<% } %>" style="padding: 5px 10px;" href="<%= switchSitePath() %>"><%= t("site_all") %></a>
                                                <a class="dropdown-item <%= if (current_site == "K") { %>active<% } %>" style="padding: 5px 10px;" href="<%= switchSitePath() %>?site=K"><%= t("site_K") %></a>
                                                <a class="dropdown-item <%= if (current_site == "L") { %>active<% } %>" style="padding: 5px 10px;" href="<%= switchSitePath() %>?site=L"><%= t("site_L") %></a>
                                                <a class="dropdown-item <%= if (current_site == "N") { %>active<% } %>" style="padding: 5px 10px;" href="<%= switchSitePath() %>?site=N"><%= t("site_N") %></a>
                                                <a class="dropdown-item <%= if (current_site == "T") { %>active<% } %>" style="padding: 5px 10px;" href="<%= switchSitePath() %>?site=T"><%= t("site_T") %></a>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                        </li>
                        <li class="">
                            <a href="/">
                                <div class="icon-w">
                                    <div class="fa fa-home"></div>
                                </div>
                                <span>
                                    <%= t("nav_home") %>
                                </span>
                            </a>
                        </li>
                        <%= if (current_user.Admin || current_user.Permission.Screening || current_user.Permission.StudyCoordinator) { %>
                        <li class="">
                            <a href="<%= participantsIndexPath() %>">
                                <div class="icon-w">
                                    <div class="fa fa-address-book"></div>
                                </div>
                                <span>
                                    <%= t("nav_participants") %></span>
                            </a>
                        </li>
                        <% } %>

                        <%= if (!current_user.Permission.Screening || current_user.Admin || current_user.Permission.ReferralTracker || current_user.Permission.StudyCoordinator || current_user.Permission.OverRead) { %>
                        <li class="">
                            <a href="<%= casesIndexPath() %>">
                                <div class="icon-w">
                                    <div class="fa fas fa-eye"></div>
                                </div>
                                <span>
                                    <%= t("nav_overreading") %></span>
                            </a>
                        </li>
                        <% } %>

                        <%= if (current_user.Admin || current_user.Permission.ReferralTracker || current_user.Permission.StudyCoordinator) { %>
                            <li class="">
                                <a href="<%= referralsIndexPath() %>">
                                    <div class="icon-w">
                                        <div class="fa fa-exchange-alt"></div>
                                    </div>
                                    <span>
                                        <%= t("nav_referrals") %></span>
                                </a>
                            </li>
                        <% } %>

                        <%= if (current_user.Admin || current_user.Permission.StudyCoordinator) { %>
                            <li>
                                <div class="menu-actions"></div>
                            </li>
                            <li class="">
                                <a href="<%= reportsIndexPath() %>">
                                    <div class="icon-w">
                                        <div class="fa fa-book"></div>
                                    </div>
                                    <span>
                                        <%= t("nav_reports") %></span>
                                </a>
                            </li>
                        <% } %>

                        <%= if (current_user.Admin) { %>
                            <li class="">
                                <a href="<%= analyticsIndexPath() %>">
                                    <div class="icon-w">
                                        <div class="fa fa-chart-pie"></div>
                                    </div>
                                    <span>
                                        <%= t("nav_analytics") %></span>
                                </a>
                            </li>
                        
                        <li class="">
                            <a href="<%= usersIndexPath() %>">
                                <div class="icon-w">
                                    <div class="fa fa-users"></div>
                                </div>
                                <span>
                                    <%= t("nav_users") %></span>
                            </a>
                        </li>

                        <li class="">
                            <a href="<%= logsIndexPath() %>">
                                <div class="icon-w">
                                    <div class="fa fa-database"></div>
                                </div>
                                <span>
                                    <%= t("nav_logs") %></span>
                            </a>
                        </li>
                        <% } %>
                    </ul>
                </div>
            </div>
        <div class="content-w"">
            <div class="top-bar color-scheme-white">
                 <!--------------------
              START - Breadcrumbs
              -------------------->
              <%= if (breadcrumbMap) { %>
                <ul class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="<%= rootPath() %>">
                            <%= t("nav_home") %></a>
                    </li>

                    <%= for (k, v) in breadcrumbMap { %>
                    <li class="breadcrumb-item">
                        <%= if (len(v) > 0) { %>
                        <a href="<%= v %>">
                            <%= t(k) %></a>
                        <% } else { %>
                        <span>
                            <%= t(k) %></span>
                        <% } %>
                    </li>
                    <% } %>
                </ul>
                <!--------------------
              END - Breadcrumbs
              -------------------->
                <% } %>
                <div class="top-menu-controls">
                    <div class="menu-actions">
                        <div class="btn-group">
                            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <%= if (current_lang && current_lang == "th") { %>
                                <img src="<%= assetPath("img/flags-icons/th.png") %>" height="25px"> <%= t("language_th") %>
                                <% } else { %>
                                <img src="<%= assetPath("img/flags-icons/us.png") %>" height="25px"> <%= t("language_en") %>
                                <% } %>
                            </button>
                            <div class="dropdown-menu">
                                <%= if (current_lang && current_lang == "bn") { %>
                                <a class="dropdown-item" style="padding: 10px 5px;" href="<%= switchPath() %>?lang=en"><img src="<%= assetPath("img/flags-icons/us.png") %>" height="25px"> <%= t("language_en") %></a>
                                <a class="dropdown-item" style="padding: 10px 5px;" href="<%= switchPath() %>?lang=th"><img src="<%= assetPath("img/flags-icons/th.png") %>" height="25px"> <%= t("language_th") %></a>
                                <% } else if (current_lang && current_lang == "th") { %>
                                <a class="dropdown-item" style="padding: 10px 5px;" href="<%= switchPath() %>?lang=en"><img src="<%= assetPath("img/flags-icons/us.png") %>" height="25px"> <%= t("language_en") %></a>
                                <a class="dropdown-item active" style="padding: 10px 5px;" href="<%= switchPath() %>?lang=th"><img src="<%= assetPath("img/flags-icons/th.png") %>" height="25px"> <%= t("language_th") %></a>
                                <% } else { %>
                                <a class="dropdown-item active" style="padding: 10px 5px;" href="<%= switchPath() %>?lang=en"><img src="<%= assetPath("img/flags-icons/us.png") %>" height="25px"> <%= t("language_en") %></a>
                                <a class="dropdown-item" style="padding: 10px 5px;" href="<%= switchPath() %>?lang=th"><img src="<%= assetPath("img/flags-icons/th.png") %>" height="25px"> <%= t("language_th") %></a>
                                <% } %>
                            </div>
                        </div>
                    </div>
                    <div class="logged-user-w avatar-inline">
                        <div class="logged-user-i">
                            <div class="avatar-w">
                                <%= if (len(current_user.Avatar) > 10) { %>
                                    <img alt="" src="<%= current_user.Avatar %>">
                                <% } else { %>
                                    <img alt="" src="<%= assetPath("images/avatar1.jpg") %>">
                                <% } %>
                            </div>
                            <div class="logged-user-info-w">
                                <div class="logged-user-name">
                                    <%= current_user.Name %>
                                </div>
                                <div class="logged-user-role">
                                    <%= if (current_user.Admin) { %>
                                    <%= t("role_admin") %>
                                    <% } else if (current_user.Permission.StudyCoordinator) { %>
                                    <%= t("role_study_coordinator") %>
                                    <% } else if (current_user.Permission.Screening) { %>
                                    <%= t("role_screener") %>
                                    <% } else if (current_user.Permission.OverRead) { %>
                                    <%= t("role_reader") %>
                                    <% } else if (current_user.Permission.ReferralTracker) { %>
                                    <%= t("role_referral_tracker") %>
                                    <% } else { %>
                                    <%= t("role_general") %>
                                    <% } %>
                                </div>
                            </div>
                            <div class="logged-user-toggler-arrow">
                                <div class="os-icon os-icon-chevron-down"></div>
                            </div>
                            <div class="logged-user-menu color-style-bright">
                                <div class="logged-user-avatar-info">
                                    <div class="avatar-w">
                                            <%= if (len(current_user.Avatar) > 10) { %>
                                                <img alt="" src="<%= current_user.Avatar %>">
                                            <% } else { %>
                                                <img alt="" src="<%= assetPath("images/avatar1.jpg") %>">
                                            <% } %>
                                    </div>
                                    <div class="logged-user-info-w">
                                        <div class="logged-user-name">
                                            <%= current_user.Name %>
                                        </div>
                                        <div class="logged-user-role">
                                            <%= if (current_user.Admin) { %>
                                            <%= t("role_admin") %>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-icon">
                                    <i class="os-icon os-icon-wallet-loaded"></i>
                                </div>
                                <ul>
                                    <li>
                                        <a href="<%= usersLogoutPath() %>"><i class="os-icon os-icon-signs-11"></i><span>
                                                <%= t("nav_logout") %></span></a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--------------------
            END - Main Menu
            -------------------->

            <div class="content-i" style="background: #fff;">
                <div class="content-box container">
                    <%= partial("flash.html") %>
                    <%= yield %>
                </div>
            </div>
            <%= if (len(audits) > 0) { %>
            <div class="content-box" style="background: #fff;">
                <%= partial("audits.html") %>
            </div>
            <% } %>
        </div>
    </div>
</div>

<%= javascriptTag("application.js") %>
<%= javascriptTag("imageviewer.js") %>
<%= javascriptTag("validator.js") %>
<%= javascriptTag("Chart.js") %>
    <script>
        $(function () {
            toogleReferralRefusalBox();

            $(".select2").select2();
            $('.tasks-header-toggler').on('click', function () {
                $(this).closest('.tasks-section').find('.tasks-list-w').slideToggle(300);
                return false;
            });

            $('.expand-row').on('click', function (e) {
                e.preventDefault()
                var elemId = $(this).attr("data-src")
                var elemContent = elemId + "-content"
                // alert(elemId)
                var accordionRow = $("#"+elemId);
                var accordionContent = $("#"+elemContent);
                // alert(accordionRow.html())
                if (!accordionRow.is(":visible")) {
                    accordionRow.show()
                    accordionContent.slideDown()
                } else {
                    accordionContent.slideUp()
                    accordionRow.hide();
                }
            });

            var viewer = ImageViewer();
            $('.fullscreen-image').click(function () {
                var imgSrc = this.src,
                    highResolutionImage = $(this).data('high-res-src');

                viewer.show(imgSrc, highResolutionImage);
            });

            $(".participantID_field").inputmask("AA-9999-9");
            $(".birth_year_field").inputmask("9999", { "clearIncomplete": true, "max": 2800, "min": 1900 });

            if (typeof Chart !== 'undefined') {

                var fontFamily = '"Proxima Nova W01", -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif';
                // set defaults
                Chart.defaults.global.defaultFontFamily = fontFamily;
                Chart.defaults.global.tooltips.titleFontSize = 14;
                Chart.defaults.global.tooltips.titleMarginBottom = 4;
                Chart.defaults.global.tooltips.displayColors = false;
                Chart.defaults.global.tooltips.bodyFontSize = 12;
                Chart.defaults.global.tooltips.xPadding = 10;
                Chart.defaults.global.tooltips.yPadding = 8;

                // init pie chart if element exists
                if ($("#pieChart1").length) {
                var pieChart1 = $("#pieChart1");

                // pie chart data
                var pieData1 = {
                    labels: ["Red", "Blue", "Yellow", "Green", "Purple"],
                    datasets: [{
                    data: [300, 50, 100, 30, 70],
                    backgroundColor: ["#5797fc", "#7e6fff", "#4ecc48", "#ffcc29", "#f37070"],
                    hoverBackgroundColor: ["#5797fc", "#7e6fff", "#4ecc48", "#ffcc29", "#f37070"],
                    borderWidth: 0
                    }]
                };

                // -----------------
                // init pie chart
                // -----------------
                new Chart(pieChart1, {
                    type: 'pie',
                    data: pieData1,
                    options: {
                    legend: {
                        position: 'bottom',
                        labels: {
                        boxWidth: 15,
                        fontColor: '#3e4b5b'
                        }
                    },
                    animation: {
                        animateScale: true
                    }
                    }
                });
                }

                // -----------------
                // init donut chart if element exists
                // -----------------
                if ($("#donutChart").length) {
                var donutChart = $("#donutChart");

                // donut chart data
                var data = {
                    labels: ["Red", "Blue", "Yellow", "Green", "Purple"],
                    datasets: [{
                    data: [300, 50, 100, 30, 70],
                    backgroundColor: ["#5797fc", "#7e6fff", "#4ecc48", "#ffcc29", "#f37070"],
                    hoverBackgroundColor: ["#5797fc", "#7e6fff", "#4ecc48", "#ffcc29", "#f37070"],
                    borderWidth: 0
                    }]
                };

                // -----------------
                // init donut chart
                // -----------------
                new Chart(donutChart, {
                    type: 'doughnut',
                    data: data,
                    options: {
                    legend: {
                        display: false
                    },
                    animation: {
                        animateScale: true
                    },
                    cutoutPercentage: 80
                    }
                });
                }

                // -----------------
                // init donut chart if element exists
                // -----------------
                if ($("#donutChart1").length) {
                var donutChart1 = $("#donutChart1");

                // donut chart data
                var data1 = {
                    labels: ["Red", "Blue", "Yellow", "Green", "Purple"],
                    datasets: [{
                    data: [300, 50, 100, 30, 70],
                    backgroundColor: ["#5797fc", "#7e6fff", "#4ecc48", "#ffcc29", "#f37070"],
                    hoverBackgroundColor: ["#5797fc", "#7e6fff", "#4ecc48", "#ffcc29", "#f37070"],
                    borderWidth: 6,
                    hoverBorderColor: 'transparent'
                    }]
                };

                // -----------------
                // init donut chart
                // -----------------
                new Chart(donutChart1, {
                    type: 'doughnut',
                    data: data1,
                    options: {
                    legend: {
                        display: false
                    },
                    animation: {
                        animateScale: true
                    },
                    cutoutPercentage: 80
                    }
                });
                }
                }

                // -----------------
                // init donut chart if element exists
                // -----------------
                if ($("#donutChart2").length) {
                var donutChart1 = $("#donutChart2");

                // donut chart data
                var data1 = {
                    labels: ["Red", "Blue", "Yellow", "Green", "Purple"],
                    datasets: [{
                    data: [300, 50, 100, 30, 70],
                    backgroundColor: ["#5797fc", "#7e6fff", "#4ecc48", "#ffcc29", "#f37070"],
                    hoverBackgroundColor: ["#5797fc", "#7e6fff", "#4ecc48", "#ffcc29", "#f37070"],
                    borderWidth: 6,
                    hoverBorderColor: 'transparent'
                    }]
                };

                // -----------------
                // init donut chart
                // -----------------
                new Chart(donutChart1, {
                    type: 'doughnut',
                    data: data1,
                    options: {
                    legend: {
                        display: false
                    },
                    animation: {
                        animateScale: true
                    },
                    cutoutPercentage: 80
                    }
                });
            }
        
            $("#screeningForm").on("submit", function (e) {
                // e.preventDefault();
                shouldRefer = false;

                var rva = $("select[name='Eyes.RightEye.VisualAcuity']").val();
                var rlva = $("select[name='Eyes.RightEye.LastVisualAcuity']").val();
                var rdr = $("select[name='Eyes.RightEye.DRGrading']").val();
                var rdme = $("input[name='Eyes.RightEye.DMEAssessment']:checked").val();
                var lva = $("select[name='Eyes.LeftEye.VisualAcuity']").val();
                var llva = $("select[name='Eyes.LeftEye.LastVisualAcuity']").val();
                var ldr = $("select[name='Eyes.LeftEye.DRGrading']").val();
                var ldme = $("input[name='Eyes.LeftEye.DMEAssessment']:checked").val();
                
                var referralNotes = $('#referral-notes').val();
                var referral = $("input[name=referral]:checked").val();

                // console.log("rva=", rva, "rlva=", rlva, "rdr=", rdr, "rdme=", rdme, "lva=", lva, "llva=", llva, "ldr=", ldr, "ldme=", ldme);
                // console.log("referralNotes=", referralNotes, "referral=", referral)

                /*
                    - Ungradeable image in either eye (for DR or DME)
                    - Severe NPDR or above in either eye
                    - DME present in either eye
                    - V/A 20/70 or worse
                    - Worsening vision defined as reduced visual acuity by 2 or more lines over repeat visits
                */

                var vaValues = ["20/20", "20/30", "20/40", "20/50", "20/70", "20/100", "20/200", "CF", "HM", "LP", "NLP"]
                var rvaIndex = vaValues.indexOf(rva)
                var rlvaIndex = vaValues.indexOf(rlva)
                var lvaIndex = vaValues.indexOf(lva)
                var llvaIndex = vaValues.indexOf(llva)

                // console.log("rvaIndex=", rvaIndex, "rlvaIndex=", rlvaIndex, "lvaIndex=", lvaIndex, "llvaIndex=", llvaIndex)

                if (rdr == "Ungradeable" || rdme == "Ungradeable" || ldr == "Ungradeable" || ldme == "Ungradeable") {
                    shouldRefer = true
                } else if (rdr == "Severe DR" || rdr == "Proliferative DR" || ldr == "Severe DR" || ldr == "Proliferative DR") {
                    shouldRefer = true
                } else if (rdme == "Present" || ldme == "Present") {
                    shouldRefer = true
                } else if (rvaIndex >= 4 || lvaIndex >= 4) {
                    shouldRefer = true                    
                } else if (rvaIndex < 4 && (rvaIndex-rlvaIndex) >= 2) {
                    shouldRefer = true 
                } else if (lvaIndex < 4 && (lvaIndex-llvaIndex) >= 2) {
                    shouldRefer = true 
                }

                // console.log("SHOULD REFER =", shouldRefer);

                if (shouldRefer && $.trim(referralNotes).length == 0 && referral != "yes") {
                    e.preventDefault();
                    $('#referral-error').html("<div class=\"alert alert-danger alert-dismissible fade show\" role=\"alert\"><%= t("label_referral_refused_error") %><button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button></div>");
                    $('#referral-notes').focus();
                }
            });
            
            $("#referral_yes").on("change", function () {
                toogleReferralRefusalBox();
            });

            $("#referral_no").on("change", function () {
                toogleReferralRefusalBox();
            });
        });

        function toogleReferralRefusalBox() {
            var referral = $("input[name=referral]:checked").val();
            if (referral == "yes") {
                $("#referral-refused-box").show();
            } else {
                $("#referral_refused").prop("checked", false);
                $("#referral-refused-box").hide();
            }
        }
    </script>
</body>

</html>
